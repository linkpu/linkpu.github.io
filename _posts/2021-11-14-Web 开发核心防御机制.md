---
redirect_from: /_posts/2021-11-14-Web%20%E5%BC%80%E5%8F%91%E6%A0%B8%E5%BF%83%E9%98%B2%E5%BE%A1%E6%9C%BA%E5%88%B6/
title: Web 开发核心防御机制
tags: Web 攻防
layout: home
---

# Web 开发核心防御机制

Web 应用程序的基本安全问题：所有用户输入都不可信。

<!-- slide -->

- 处理用户访问，防止用户获得未授权访问。
- 处理用户输入，防止错误输入造成不良行为。
- 处理攻击者，确保应用程序成为攻击目标时能够正常运转。
- 管理应用程序，帮助管理员监控应用程序的功能，并配置其功能。

<!-- slide -->

## 处理用户访问

几乎任何应用程序都必须满足一个中心安全要求，即处理用户访问其数据与功能。

大多数 Web 应用程序使用三层相互关联的安全机制处理用户访问：

    - 身份验证
    - 会话管理
    - 访问控制


<!-- slide -->

### 身份验证

身份验证是 Web 应用程序处理用户访问的最基本机制。用户一般分为几种类型，如匿名用户、正常通过验证的用户和管理用户，多数情况下，不同的用户只允许访问不同的数据。

身份验证相关的功能缺陷，比如攻击者可能确定其他用户的用户名、推测出他们的密码，或者完全避开登录功能，这些缺陷往往允许攻击者非法访问敏感的数据和功能。

<!-- slide -->

### 会话管理

Web 应用程序可以通过会话识别并处理每一名用户提交的请求，实施有效的访问控制。

会话本身是一组保存在服务器上的数据结构，用于追踪用户与应用程序的交互状态，Web 应用程序通过为每一位用户建立一个会话，并向用户发布一个标识会话的令牌，浏览器会在随后的 HTTP 请求中将这个令牌返回给服务器。一些应用程序使用隐藏表单字段或 URL 查询字符串传送会话令牌，但 HTTP cookie 才是实现这一过程的常规方法。

会话管理的有效性主要取决于其令牌的安全性，绝大多数攻击都尝试攻破其他用户的令牌。令牌的生成过程中的缺陷是主要的漏洞来源，攻击者会利用漏洞推测出发布给其他用户的令牌，从而像正常通过验证的用户一样使用应用程序。

<!-- slide -->

### 访问控制

应用程序除了需要确认每一个请求中用户的身份，还需要决定是否执行其所请求的操作或者访问相关的数据。

<!-- slide -->

## 处理用户输入

大量针对 Web 应用程序的不同攻击都与提交错误输入有关，攻击者通过专门设计一些输入，引发应用程序发生一些无法预料的行为。

<!-- slide -->

- 输入的多样性
- 输入处理方法
- 边界确认
- 多步确认与规范化

<!-- slide -->

### 输入的多样性

在许多情况下，应用程序会对一些特殊的输入实行非常严格检查，例如提交登录功能的用户名最大长度为 8 个字符，且只能包含数字、字母等。在其他情况下，应用程序必须接受更广泛的字符。

<!-- slide -->

### 输入处理方法

- 拒绝已知的不良输入
- 接受已知的正常输入
- 净化
- 安全数据处理
- 语法检查

<!-- slide -->

### 边界确认

虽然在客户端执行的输入确认检查可以提高性能，改善用户体验，但它们并不能为实际到达服务器的数据提供任何保证。服务器端应用程序第一次收到用户数据的地方是一个重要的信任边界，应用程序需要在此采取措施防御恶意输入。

边界确认是一种更加有效的模型。此时服务器端应用程序的每一个单独的组件或功能单元将其输入当做来自潜在恶意来源的输入对待，每个组件都可以防御它收到的特殊类型的专门设计的输入。

<!-- slide -->

一种典型情况，此时边界确认是防御恶意输入的最有效方法。

1. 应用程序收到用户的登录信息。表单处理程序确认每个输入仅包含合法字符，符合特殊的长度限制，并且不包含任何已知的攻击签名。
2. 应用程序执行一个SQL查询检验用户证书。为防止SQL注入攻击，在执行查询前，应用程序应对用户输入中包含的可用于攻击数据库的所有字符进行转义。
3. 如果用户成功登录，应用程序再将用户资料中的某些数据传送给[SOAP服务](https://www.w3school.com.cn/soap/soap_intro.asp)，进一步获得用户账户的有关信息。为防止SOAP注入攻击，需要对用户资料中的任何XML元字符进行适当编码。
4. 应用程序在用户的浏览器中显示用户的账户信息。为防止跨站点脚本攻击，应用程序对植入返回页面的任何用户提交的数据执行HTML编码。

![一种再多阶段处理步骤中使用边界确认的应用程序功能](http://www.ituring.com.cn/figures/2012/The%20Web%20Application%20Hacker's%20Handbook/07.d02z.05.png)

<!-- slide -->

### 多步确认与规范化

例如，为防御某些跨站点脚本攻击，应用程序可能会从任何用户提交的数据中删除表达式：

```
<script>
```

但攻击者可通过以下输入避开过滤器：

```
<scr<script>ipt>
```

由于过滤无法递归运行，删除被阻止的表达式后，表达式周围的数据又合并在一起，重新建立恶意表达式。

同样，如果对用户输入执行几个确认步骤，攻击者就可以利用这些步骤的顺序来避开过滤。例如，如果应用程序首先递归删除`../`，然后递归删除`..\`，就可以使用以下输入避开确认检查：

```
....\/
```

<!-- slide -->

数据规范化（data canonicalization）会造成另一个问题。当用户浏览器送出输入时，它可对这些输入进行各种形式的编码。之所以使用这些编码方案，是为了能够通过HTTP安全传送不常见的字符与二进制数据。规范化是指将数据转换或解码成一个常见字符集的过程。如果在实施输入过滤之后才执行规范化，那么攻击者就可以通过使用编码避开确认机制。

例如，应用程序可能会从用户输入中删除省略号，以防止某些SQL注入攻击。但是，如果应用程序随后对净化后的数据进行规范化，那么攻击者就可以使用URL编码的输入避开确认：

```
%2527
```

收到该输入后，应用程序服务器会执行正常的URL解码，因此该输入变为：

```
%27
```

其中并不包含省略号，因此，应用程序的过滤器允许该输入。但是，如果应用程序执行进一步的URL解码，该输入将变为省略号，从而避开过滤。

<!-- slide -->

一种解决办法是递归执行净化操作，直到无法进一步修改输入。然而，如果需要在净化过程中对一个存在疑问的字符进行转义，那么这种情况可能会造成无限循环。通常，这个问题只有根据具体情况、基于所执行的确认类型加以解决。如果可能，最好避免净化某些不良输入的做法，完全拒绝这种类型的输入。

<!-- slide -->

## 处理攻击者

<!-- slide -->

- 处理错误，过于详细的错误信息有利于恶意用户向应用程序发动进一步攻击。
- 维护审计日志，通过日志记录所有重要事件以及关键信息。
- 向管理员发出警报，通知管理员采取应对措施。
- 应对攻击，通过应用程序的内置机制防御恶意用户。

<!-- slide -->

## 管理应用程序

管理与维护应用程序是应用程序安全机制的一个重要组成部分，可帮助管理员管理用户账户与角色、应用监控与审计功能、执行诊断任务并配置应用程序的各种功能。

<!-- slide -->

管理机制很容易成为应用程序的主要攻击面，主要在于它能够提升权限。

- 身份验证机制中存在的薄弱环节使攻击者能够获得管理员权限，迅速攻破整个应用程序。
- 许多应用程序并不对它的一些管理功能执行有效的访问控制，利用这一点，攻击者可以建立一个拥有强大特权的新用户账户。
- 管理功能通常能够显示普通用户提交的数据。管理界面中存在的任何跨站点脚本缺陷都可能危及用户会话的安全。
- 管理用户被视为可新用户，通常需要执行一些比较危险的操作，包括访问瓷盘上的文件或者操作系统命令，如果一名攻击者能攻破管理功能，就可能利用它控制整个服务器。